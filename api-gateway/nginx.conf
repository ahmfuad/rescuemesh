events {
    worker_connections 1024;
}

http {
    # Upstream Services
    upstream user-service {
        server user-service:3001;
    }

    upstream skill-service {
        server skill-service:3002;
    }

    upstream disaster-service {
        server disaster-service:3003;
    }

    upstream sos-service {
        server sos-service:3004;
    }

    upstream matching-service {
        server matching-service:3005;
    }

    upstream notification-service {
        server notification-service:3006;
    }

    # Rate limiting
    limit_req_zone $binary_remote_addr zone=user_limit:10m rate=20r/s;
    limit_req_zone $binary_remote_addr zone=skill_limit:10m rate=20r/s;
    limit_req_zone $binary_remote_addr zone=disaster_limit:10m rate=15r/s;
    limit_req_zone $binary_remote_addr zone=sos_limit:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=matching_limit:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=notification_limit:10m rate=5r/s;

    server {
        listen 80;
        server_name localhost;

        # CORS headers
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization' always;

        if ($request_method = 'OPTIONS') {
            return 204;
        }

        # Service 1: User & Identity Service
        location /api/users/ {
            limit_req zone=user_limit burst=30 nodelay;
            proxy_pass http://user-service/api/users/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Service 2: Skill & Resource Registry
        location /api/skills/ {
            limit_req zone=skill_limit burst=30 nodelay;
            proxy_pass http://skill-service/api/skills/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /api/resources/ {
            limit_req zone=skill_limit burst=30 nodelay;
            proxy_pass http://skill-service/api/resources/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /api/disaster-templates/ {
            limit_req zone=skill_limit burst=20 nodelay;
            proxy_pass http://skill-service/api/disaster-templates/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Service 3: Disaster Event Service
        location /api/disasters/ {
            limit_req zone=disaster_limit burst=25 nodelay;
            proxy_pass http://disaster-service/api/disasters/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Unified API Documentation
        location = /docs {
            root /usr/share/nginx/html;
            try_files /api-docs.html =404;
        }

        # Disaster Service Swagger (original)
        location /docs/disaster {
            proxy_pass http://disaster-service/docs;
            proxy_set_header Host $host;
        }

        location /redoc {
            proxy_pass http://disaster-service/redoc;
            proxy_set_header Host $host;
        }

        location /openapi.json {
            proxy_pass http://disaster-service/openapi.json;
            proxy_set_header Host $host;
        }

        # Service 4: SOS Service
        location /api/sos/ {
            limit_req zone=sos_limit burst=20 nodelay;
            proxy_pass http://sos-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Service 5: Matching Service
        location /api/matching/ {
            limit_req zone=matching_limit burst=20 nodelay;
            proxy_pass http://matching-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Service 6: Notification Service
        location /api/notifications/ {
            limit_req zone=notification_limit burst=10 nodelay;
            proxy_pass http://notification-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Health check endpoints
        location = /health {
            access_log off;
            return 200 "Gateway healthy\n";
            add_header Content-Type text/plain;
        }

        location /health/user {
            proxy_pass http://user-service/health;
            access_log off;
        }

        location /health/skill {
            proxy_pass http://skill-service/health;
            access_log off;
        }

        location /health/disaster {
            proxy_pass http://disaster-service/health;
            access_log off;
        }

        location /health/sos {
            proxy_pass http://sos-service/health;
            access_log off;
        }

        location /health/matching {
            proxy_pass http://matching-service/health;
            access_log off;
        }

        location /health/notification {
            proxy_pass http://notification-service/health;
            access_log off;
        }

        # Dashboard
        location = / {
            return 200 "<html><body><h1>RescueMesh API Gateway</h1><p>Gateway running. <a href='/docs'>API Docs</a></p></body></html>\n";
            add_header Content-Type text/html;
        }
    }
}
