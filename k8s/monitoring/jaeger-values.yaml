# Jaeger Distributed Tracing Configuration
# For end-to-end transaction monitoring across microservices

# Deployment strategy
provisionDataStore:
  cassandra: false  # Use Elasticsearch instead
  elasticsearch: true

# Elasticsearch storage backend
storage:
  type: elasticsearch
  elasticsearch:
    host: elasticsearch-master
    port: 9200
    scheme: http
    user: elastic
    usePassword: true
    password: "${ELASTICSEARCH_PASSWORD}"
    nodesWanOnly: false
  
  # Index configuration
  esIndexCleaner:
    enabled: true
    numberOfDays: 7  # Keep traces for 7 days
    schedule: "55 23 * * *"

# Jaeger Agent - runs as DaemonSet on each node
agent:
  enabled: true
  
  # DaemonSet configuration
  daemonset:
    useHostPort: true
  
  # Resource allocation
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
  
  # Service configuration
  service:
    type: ClusterIP
    # Jaeger agent ports
    zipkinThriftPort: 5775
    compactPort: 6831
    binaryPort: 6832
    samplingPort: 5778

# Jaeger Collector - receives traces from agents
collector:
  enabled: true
  
  # Number of replicas for HA
  replicaCount: 2
  
  # Resource allocation
  resources:
    requests:
      cpu: 200m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 1Gi
  
  # Service configuration
  service:
    type: ClusterIP
    # Collector ports
    grpc:
      port: 14250
    http:
      port: 14268
    zipkin:
      port: 9411
  
  # Autoscaling
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 70
  
  # Sampling strategies
  samplingConfig: |
    {
      "default_strategy": {
        "type": "probabilistic",
        "param": 0.1
      },
      "service_strategies": [
        {
          "service": "user-service",
          "type": "probabilistic",
          "param": 0.5
        },
        {
          "service": "matching-service",
          "type": "probabilistic",
          "param": 0.5
        },
        {
          "service": "sos-service",
          "type": "probabilistic",
          "param": 1.0
        }
      ]
    }

# Jaeger Query - UI and API for trace queries
query:
  enabled: true
  
  # Number of replicas
  replicaCount: 2
  
  # Resource allocation
  resources:
    requests:
      cpu: 200m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  
  # Service configuration
  service:
    type: ClusterIP
    port: 16686
  
  # Ingress for UI access
  ingress:
    enabled: true
    annotations:
      kubernetes.io/ingress.class: nginx
      cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/auth-type: basic
      nginx.ingress.kubernetes.io/auth-secret: jaeger-auth
      nginx.ingress.kubernetes.io/auth-realm: 'Authentication Required'
    hosts:
      - jaeger.villagers.live
    tls:
      - secretName: jaeger-tls
        hosts:
          - jaeger.villagers.live
  
  # Base path for UI
  basePath: /

# Spark dependencies (optional - for dependency graphs)
spark:
  enabled: false

# Kafka for trace buffering (optional)
kafka:
  enabled: false

# Elasticsearch index cleaner
esIndexCleaner:
  enabled: true
  numberOfDays: 7
  schedule: "55 23 * * *"
  
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 128Mi

# Jaeger Operator (alternative deployment method)
# jaegerOperator:
#   enabled: false

# Global settings
allInOne:
  enabled: false  # We use individual components

# Hotrod example application (for testing)
hotrod:
  enabled: false

# Tag configuration for better trace filtering
agent:
  extraEnv:
    - name: JAEGER_AGENT_TAGS
      value: "cluster=rescuemesh,environment=production,region=nyc3"

collector:
  extraEnv:
    - name: SPAN_STORAGE_TYPE
      value: elasticsearch
    - name: COLLECTOR_ZIPKIN_HOST_PORT
      value: ":9411"
    - name: COLLECTOR_OTLP_ENABLED
      value: "true"

query:
  extraEnv:
    - name: SPAN_STORAGE_TYPE
      value: elasticsearch
    - name: QUERY_BASE_PATH
      value: /
